# LocaAlert 챌린지 기능 기획 정리

## 1. 핵심 결정 사항

### 루틴 → 챌린지 전환
- 기존 "루틴" 탭/기능을 제거하고 그 자리를 **챌린지**로 대체
- 챌린지와 루틴의 개념이 겹쳐서 유저에게 혼란을 주는 문제 해소
- 챌린지 = **위치 기반 방문 목표 달성 시스템**

### 챌린지 개수 제한
- 동시 진행 가능한 챌린지: **최대 2개**
- 이유: 위치 추적 비용, 행동심리학적 목표 과부하 방지, UI 복잡도 관리
- 2개 초과 생성 시도 시 → "진행 중인 챌린지를 완료하면 새로 시작할 수 있어요" 안내

---

## 2. 챌린지 랜딩 페이지 (challenge-landing)

### 상태별 UI 분기

#### ① 챌린지 없음 (첫 진입)
- **상단**: 공감형 한 줄 설명 (첫 진입에서만 노출)
  - 예시: "작심삼일도 괜찮아요. 장소만 정하면 몸이 기억해요."
  - 예시: "가기만 하면 반은 성공. 나머지는 LocaAlert가 챙길게요."
  - 톤: 자조가 아닌 **공감형** (범용 유저 대상이므로)
- **중단**: 추천 챌린지 (카드형)
  - 위치 기반 특성을 반영한 템플릿 (예: "단골 헬스장 주 3회", "도서관 주 5회")
- **하단**: "나만의 챌린지 만들기" 버튼 → challenge-create로 이동

#### ② 진행 중인 챌린지 있음
- **상단 설명 영역 숨김**
- **진행 중 챌린지 카드**를 최상단에 크게 배치
  - 프로그레스 시각 강조 (원형 or 큰 숫자)
  - "3/5회 완료" 보다 → **"이번 주 2번만 더!"** 같은 동기부여형 표현
  - D-day 뱃지 유지
  - 카드 탭 → 챌린지 상세(기록/달성 히스토리)로 이동
- **하단**: 추천 챌린지 + 새 챌린지 추가 (세컨더리 위치)

#### ③ 챌린지 완료 (기간 만료)
- 축하 메시지 + 결과 요약 ("5회 중 4회 달성!")
- "다시 도전하기" / "새 챌린지 시작" CTA
- 완료 기록은 히스토리에 보존

---

## 3. 챌린지 구조 설계

### 기본 구조
```
장소 선택 + 주 N회 목표 + 기간(3주) 또는 반복 모드
```

| 항목 | 설정값 |
|------|--------|
| 장소 | 지도에서 선택 (홈 탭의 위치 선택 플로우 재활용) |
| 주간 목표 | 1~7회 (스테퍼로 조절) |
| 요일 지정 | 선택 옵션 — OFF(기본): 주 N회 아무 요일이나 달성 OK / ON: 요일 칩(월~일)에서 원하는 요일 탭하여 지정 |
| 기간 | 1주일 단위로 설정, 유저는 필요에 따라 2주,3주,4주 이렇게 세팅을 해둘수 있음 최대 두달 (또는 반복 모드 ON) |
| 반복 모드 | 토글 — ON이면 최고 긴 시간으로 설정된후 (두달, 약 8주) 그후에 다시 자동으로 다음 사이클 시작 |
| 아이콘 | 5종 중 선택 (fitness, walk, book, cafe, bicycle) |
| 이름 | 커스텀 입력 (선택) |

### 요일 지정 상세

#### 기본 모드 (요일 지정 OFF)
- "주 3회 헬스장" → 월~일 중 아무 때나 3회 방문하면 주간 목표 달성
- 유연함이 핵심 — 의지박약 타겟 유저에게 고정 요일은 부담, 하루 못 가면 바로 "실패" 느낌
- **대부분의 유저에게 권장되는 기본값**

#### 요일 지정 모드 (요일 지정 ON)
- "주 3회 + 월·수·금" → 해당 요일에만 출석이 유효, 다른 요일에 가도 카운트 안 됨
- 주간 목표 횟수와 선택한 요일 수가 일치해야 함 (주 3회면 요일도 3개 선택)
- 습관이 어느 정도 잡힌 유저가 패턴을 고정하고 싶을 때 사용하는 **강화 모드**
- UI: 주간 목표 스테퍼 아래에 요일 칩 7개(월~일) 가로 배치, 탭으로 선택/해제

#### 출석 판정 차이
| 모드 | 화요일에 헬스장 방문 시 (주 3회 월·수·금 챌린지) |
|------|------------------------------------------------|
| 요일 지정 OFF | ✅ 카운트 됨 (주 안에 3회만 채우면 OK) |
| 요일 지정 ON | ❌ 카운트 안 됨 (월·수·금만 유효) |

### 진행 사이클
```
챌린지 생성
  ↓
매주 진행: 위치 도착 시 자동 출석 카운트 (요일 지정 모드면 해당 요일만 유효)
  ↓
주간 완료 → 콤보 +1, 축하 피드백, 카드 시각 변화
주간 실패 → 찬스 소모 or 콤보 리셋 (부드러운 안내)
  ↓
목표시간 도달 완료 → 졸업 카드 + 히스토리 기록 (리워드)
반복 모드 → 콤보 유지하며 다음 사이클 자동 시작
```

---

## 4. 콤보(보상) 시스템

### 기본 규칙
- 주간 목표 달성 시 콤보 +1
- 콤보는 연속 주간 달성 횟수

### 방어권 (찬스 시스템)
- 챌린지 시도중 **1회는 실패해도 콤보 유지**
- 3콤보 달성시 방어권 하나 증정
- "찬스" 네이밍으로 심리적 안전망 제공
- 의지박약 타겟 유저에게 콤보 리셋은 가장 큰 이탈 요인 → 방어권으로 완화

### 시각적 변화 (카드 등급)
| 콤보 | 카드 변화 |
|------|-----------|
| 1콤보 | 기본 카드 |
| 3콤보 | 은색 테두리 + "꾸준히 하는 중" 뱃지 |
| 5콤보 | 골드 테두리 + "습관 달인" 뱃지 |
| 10콤보 | 스페셜 이펙트 |

### 마이크로 리워드 (주간 완료 시)
- 햅틱 피드백 (Haptics.notificationAsync Success)
- 체크 애니메이션
- "이번 주도 해냈어요!" 한 줄 축하 메시지
- 화려할 필요 없이 간결하게

### 졸업 시스템 (목표 기간 완료 시)
- 완료 기록이 히스토리에 보존
- "헬스장 4주 챌린지 달성" 졸업 카드 생성
- 반복 모드 유저: 콤보 유지 + 다음 사이클 자동 시작

---

## 5. 체류 시간 인증 (선택 옵션)

### 목적
- 단순 통과/근처 지나감과 실제 방문을 구분
- "헬스장 앞을 지나갔는데 출석 인정" 방지 → 챌린지 신뢰도 확보

### 기본 동작
```
반경 진입 → 타이머 자동 시작 → 반경 이탈 → 타이머 종료 → 최소 시간 충족 여부 판별
```
- 유저가 별도 조작할 필요 없음 (기존 위치 추적 로직 위에 동작)
- 챌린지 생성 시 **선택 옵션** (토글 OFF가 기본, ON 시 시간 설정)
- 도서관/헬스장처럼 체류가 중요한 챌린지에 적합, 산책/통과형 챌린지는 OFF

### 시간 설정
- 프리셋 선택: **15분 / 30분 / 1시간 / 2시간**
- 자유 입력보다 선택지 방식으로 유저 부담 최소화

### 체류 중 피드백
- 알림 바에 조용하게 표시: "헬스장 체류 중 — 23분/30분"
- 최소 시간 달성 시 → "출석 완료!" 푸시 알림
- 챌린지 카드에 체류 시간 뱃지 표시

### 엣지 케이스 대응

#### GPS 흔들림 (2중 필터)
- **1단계 — Accuracy 필터:** GPS Accuracy 50m 초과 데이터는 이탈 판정에서 무시 (PRD 기존 보정 로직과 동일 기준)
- **2단계 — 유예 시간:** 유효한 이탈이어도 **3분 이내 재진입 시 타이머 유지** (건물 외벽 근처 등 커버)

#### 폰 락커 보관 (위치 업데이트 부재)
- 폰이 락커에 들어가면 GPS/Wi-Fi 모두 안 잡힘 → 이탈 이벤트도 미발생
- **"마지막 유효 위치가 반경 내 + N분간 위치 업데이트 없음 → 체류 지속으로 간주"**
- 별도 로직 추가 없이, 이탈 이벤트 부재 자체가 체류를 의미

#### 배터리 사망 / 앱 강제 종료
- 반경 진입 시 SQLite에 `entered_at` 타임스탬프 기록
- 앱 재실행 시:
  - 현재 위치가 **반경 내** → `entered_at`부터 현재까지 체류로 소급 인정
  - 현재 위치가 **반경 밖** → 정확한 이탈 시점 불명 → 인정 안 함 (시스템 신뢰도 우선)

### 챌린지 구조 테이블 추가 항목

| 항목 | 설정값 |
|------|--------|
| 체류 시간 | 토글 OFF(기본) / ON 시 15분·30분·1시간·2시간 선택 |
| 유예 시간 | 내부 값 — GPS 이탈 후 3분 이내 재진입 시 타이머 유지 |

---

## 6. 설계 원칙

> **"보상을 더하는 것보다, 실패했을 때 이탈하지 않게 만드는 설계가 더 중요하다"**

- 콤보 자체는 심플해도 OK — 깨졌을 때의 경험을 부드럽게
- 위치 기반 앱의 특성을 챌린지에 녹이기 (범용 챌린지 X, 장소 + 방문 = 핵심)
- 추천 챌린지도 위치 결합형 템플릿으로 차별화
- 체류 시간 인증은 기존 위치 추적 인프라 위에 가볍게 얹는 설계 (추가 비용 최소화)

---

## 7. 영향받는 파일 (예상)

| 변경 유형 | 파일 |
|-----------|------|
| 삭제/대체 | `app/(tabs)/routines.tsx`, `app/routine-setup.tsx`, `src/stores/routineStore.ts` |
| 수정 | `app/challenge-landing.tsx`, `app/challenge-create.tsx`, `app/(tabs)/activity.tsx` |
| 신규 생성 | `src/stores/challengeStore.ts`, 챌린지 상세 화면, 졸업/축하 컴포넌트 |
| 수정 | `src/i18n/locales/ko.json`, `en.json`, `ja.json` (루틴 키 제거, 챌린지 키 추가) |
| 수정 | `app/(tabs)/_layout.tsx` (탭 네비게이션에서 루틴 → 챌린지 전환) |
